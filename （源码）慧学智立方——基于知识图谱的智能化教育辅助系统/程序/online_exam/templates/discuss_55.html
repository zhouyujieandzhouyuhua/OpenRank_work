<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>讨论区</title>
    <link rel="stylesheet" href="/static/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
    <script src="/static/js/bootstrap.min.js"></script>
</head>
<style>


 html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            background-color: #354057;

        }
        .user-details {
            display: none;
            position: absolute;
            background-color: white;
            border: 1px solid #ccc;
            padding: 10px;
            width: 300px;
            right: 20px;
            top: 64px;
            z-index: 999;
        }
        .user-avatar img {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    object-fit: cover;
}

.user-info p {
    margin-bottom: 5px;
}

.actions .favorite-btn {
    padding: 5px 10px;
    background-color: #007BFF;
    color: white;
    border: none;
    cursor: pointer;
    border-radius: 3px;
}

.actions .favorite-btn:hover {
    background-color: #0056b3;
}
        .top {
            height: 64px;
            width: 100%;
            background: #41847d;
            padding-left: 10%;
        }


        img {
            vertical-align: middle;
        }

        em {
            font-style: normal;
        }

        a img, :link img, :visited img {
            border: 0;
        }

        a:link, a:visited {
            text-decoration: none;
            color: #666666;
        }

        a:hover, a:focus {
            color: #0573bd;
            text-decoration: none;
        }

        ul, ul li {
            list-style-type: none;
        }


        #top_bg {
            height: 64px;
            width: 100%;
            background: #333;
            box-shadow: 1px 1px 7px #999;
            position: fixed;
            z-index: 999;
            left: 0;
            border-bottom: #C6C6C6 solid 1px;
        }

        .top .logo_l {
            width: 180px;
            height: 64px;
            color: #ffffff;
            float: left;
            line-height: 64px;
        }

        .nav_z {
            width: auto !important;
            height: 64px;
            float: left;
            position: relative;
            z-index: 999;
        }

        #navul li {
            float: left;
            padding: 0 20px;
            height: 64px;
            position: relative;
            text-align: center;
            line-height: 64px;
        }

        #navul li a:link, #navul li a:visited {
            font-weight: 500;
            letter-spacing: 2px;
        }

        #navul li a {
            font-size: 14px;
            color: hsla(0, 0%, 100%, .65);
        }

        #navul li a:hover {
            color: #FFF;
        }

        .login_out {
            color: hsla(0, 0%, 100%, .65);
            padding: 0 20px
        }

        .login_out:hover {
            color: #FFF;
        }

        .active {
            background-color: #1890ff;
        }

        .bottom {
            padding-top: 64px;
        }


.row {
    display: -ms-flexbox;
    display: flex;
    -ms-flex-wrap: wrap;
    flex-wrap: wrap;
    margin-right: -15px;
    margin-left: -50px;
    margin-top: -783px;
}
.list-group {
    display: -ms-flexbox;
    display: flex;
    -ms-flex-direction: column;
    flex-direction: column;
    padding-left: 0;
    margin-bottom: 0;
    border-radius: .25rem;
    width: 60%;
}

.col-md-8 {
    -ms-flex: 0 0 66.666667%;
    flex: 0 0 66.666667%;
    max-width: 66.666667%;
    margin-left: -149px;
}
</style>
<body>
<!--=========================================================================================-->
<div class="children_body" style="height: 100%">
    <div id="top_bg">
        <div class="top">
             <a class="logo_l" href="/" title="星火知立方">
    <img src="/static/icons/logo.png" alt="星火知立方 Logo" style="height: 181px; margin-left: -67px;margin-top: -59px;">
</a>
            <!--导航开始-->
            <div class="nav_z">
               <ul id="navul" class="cl" style="display: block;height: 100%;margin: 0">


                   <li id="AIcourse">
    <a href="/AIcourse" style="display: flex; align-items: center; font-size: 14px; color: hsl(0deg 0% 100%); text-decoration: none;">
        <img src="/static/icons/课程.png" alt="AI Course Icon" style="height: 20px; margin-right: 8px;">
        课程学习
    </a>
</li>


                    <li id="kaoshi">
                        <!--                        <img src="../static/images/司法考试.png" style="width:14px;height: 14px"/>-->
<!--                        <a href="/test_paper" style="font-size: 14px; color: hsl(0deg 0% 100%); ">在线考试</a>-->


                        <a href="/test_paper" style="display: flex; align-items: center; font-size: 14px; color: hsl(0deg 0% 100%); text-decoration: none;">
        <img src="/static/icons/考试.png" alt="AI Course Icon" style="height: 20px; margin-right: 8px;">
        在线考试
    </a>

                    </li>
                    {% if role == 2 %}
<!--                    <li id="shiti">-->
<!--                        &lt;!&ndash;                        <img src="../static/images/问题.png" style="width:14px;height: 14px"/>&ndash;&gt;-->
<!--                        <a href="/shiti">试题管理</a>-->
<!--                    </li>-->
<!--                    <li id="shijuan">-->
<!--                        &lt;!&ndash;                        <img src="../static/images/试卷.png" style="width:14px;height: 14px"/>&ndash;&gt;-->
<!--                        <a href="/shijuan">试卷管理</a>-->
<!--                    </li>-->
                    {% endif %}
<!--                    <li id="chengji">-->
<!--                        &lt;!&ndash;                        <img src="../static/images/成绩查询.png" style="width:14px;height: 14px"/>&ndash;&gt;-->
<!--                        <a href="/chengji">成绩管理</a>-->

<!--                    </li>-->

                    <!--                    <li id="user">-->
                    <!--                        <img src="../static/images/用户.png" style="width:14px;height: 14px"/>-->
                    <!--                        <a href="/user/user">学生管理</a>-->

                    <!--                    </li>-->
                    <li id="individual chengji">
                        <!--                        <img src="../static/images/用户.png" style="width:14px;height: 14px"/>-->
<!--                        <a href="/individual_chengji" style="font-size: 14px; color: hsl(0deg 0% 100%);">个人成绩管理</a>-->
                        <a href="/individual_chengji" style="display: flex; align-items: center; font-size: 14px; color: hsl(0deg 0% 100%); text-decoration: none;">
        <img src="/static/icons/成绩管理.png" alt="AI Course Icon" style="height: 20px; margin-right: 8px;">
        成绩管理
    </a>

                    </li>
                    <li id="index">
                        <!--                        <img src="../static/images/首页-首页.png" style="width:14px;height: 14px"/>-->
<!--                        <a href="/index" style="font-size: 14px; color: hsl(0deg 0% 100%);">学习小工具</a>-->
                        <a href="/index" style="display: flex; align-items: center; font-size: 14px; color: hsl(0deg 0% 100%); text-decoration: none;">
        <img src="/static/icons/学习助手.png" alt="AI Course Icon" style="height: 20px; margin-right: 8px;">
        学习工具
    </a>



                    </li>

                    <!--可在此处直接添加导航-->
                    <li id="ceshi">
                        <!--                        <img src="../static/images/首页-首页.png" style="width:14px;height: 14px"/>-->
<!--                        <a href="/loudongjiance" style="font-size: 14px; color: hsl(0deg 0% 100%);">知识点漏洞检测</a>-->

                         <a href="/loudongjiance" style="display: flex; align-items: center; font-size: 14px; color: hsl(0deg 0% 100%); text-decoration: none;">
        <img src="/static/icons/查漏补缺.png" alt="AI Course Icon" style="height: 20px; margin-right: 8px;">
        查漏补缺
    </a>

                    </li>
                    <li id="upexam">
                        <!--                        <img src="../static/images/首页-首页.png" style="width:14px;height: 14px"/>-->
<!--                        <a href="/upexam" style="font-size: 14px; color: hsl(0deg 0% 100%);">提交试卷</a>-->

                        <a href="/upexam" style="display: flex; align-items: center; font-size: 14px; color: hsl(0deg 0% 100%); text-decoration: none;">
        <img src="/static/icons/提交试卷.png" alt="AI Course Icon" style="height: 20px; margin-right: 8px;">
        试卷提交
    </a>

                    </li>
                    <!--可在此处直接添加导航-->
                </ul>
            </div><!--导航结束-->
            <div id="welcome-div" style="color: #ffffff;line-height: 64px;font-size: 14px;right: 20px;display: block;width: 200px;position:absolute; margin-right: -42px;">
                <span id="welcome-span">你好！{{ username }}</span>
                <a href="/login_out" class="login_out">退出</a>
            </div>
           <div id="user-details" class="user-details">

    <div class="user-info">
        <p>姓名<span>{{ username }}</span></p>
        <p>年级：<span>{{ '七年级' }}</span></p>
        <p>班级：<span>{{ '七年二班' }}</span></p>
        <p>年龄：<span>{{ '17' }}</span></p>
        <p>邮箱：<span>1943027685@qq.com</span></p>
        <p>家庭住址：<span>北京</span></p>
        <p>已获得学分：<span>{{ '20' }}</span></p>

    </div>
    <div class="actions">
        <button class="favorite-btn">收藏</button>
        <button class="favorite-btn">点赞</button>
    </div>
</div>

        </div>
    </div>
    <div class="bottom" style="height: 100%;display: block">
        {% block content %}
        {% endblock %}
    </div>

</div>



<!--======================================================================================-->
<div class="container mt-5">
    <div class="row">
        <div class="col-md-4">
            <div class="list-group mb-3">
                <h5 class="list-group-item list-group-item-action active">课程列表</h5>
                {% for course in courses %}
                <a href="#" class="list-group-item list-group-item-action">
                    {{ course.title }}
                </a>
                {% endfor %}
            </div>
        </div>

        <div class="col-md-8">
            <div class="card">
                <div class="card-header">讨论区</div>
                <div class="card-body">
                    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#newTopicModal">发布新帖子</button>
                    <div id="topicsContainer"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 创建新主题的模态框 -->
<div class="modal fade" id="newTopicModal" tabindex="-1" role="dialog" aria-labelledby="newTopicModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newTopicModalLabel">发布你的新帖子</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="newTopicForm">
                    <div class="form-group">
                        <label for="module">模块类型</label>
                        <select class="form-control" id="module" name="module">
                            <option value="teacher_qa">老师答疑模块</option>
                            <option value="general_discussion">综合讨论区</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="courseSelect">选择课程</label>
                        <select class="form-control" id="courseSelect" name="course_id">
                            {% for course in courses %}
                            <option value="{{ course.id }}">{{ course.title }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="titleInput">话题标题</label>
                        <input type="text" class="form-control" id="titleInput" name="title">
                    </div>
                    <div class="form-group">
                        <label for="descriptionInput">话题描述</label>
                        <textarea class="form-control" id="descriptionInput" name="description" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" id="submitTopic">发表</button>
            </div>
        </div>
    </div>
</div>

<!-- 查看讨论详情的模态框 -->
<div class="modal fade" id="discussionModal" tabindex="-1" role="dialog" aria-labelledby="discussionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="discussionModalLabel">讨论详情</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="discussionContent"></div>
                <div class="mt-3">
                    <h6>发表评论</h6>
                    <form id="newCommentForm">
                        <div class="form-group">
                            <label for="contentInput">评论内容</label>
                            <textarea class="form-control" id="contentInput" name="content" rows="3"></textarea>
                        </div>
                        <input type="hidden" id="topicIdInput" name="topic_id">
                        <input type="hidden" id="parentCommentIdInput" name="parent_comment_id">
                        <button type="button" class="btn btn-primary" id="submitComment">发表评论</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
$(document).ready(function() {
    function loadTopics() {
        $.ajax({
            url: "/api/topics_list/",
            type: "GET",
            success: function(topics) {
                $("#topicsContainer").empty();
                topics.forEach(function(topic) {
                    var topicCard = `
                        <div class="card mb-3">
                            <div class="card-body">
                                <h5 class="card-title">${topic.module === 'teacher_qa' ? '老师答疑区' : (topic.module === 'general_discussion' ? '综合讨论区' : topic.module)}</h5>
                                <h5 class="card-title">${topic.title}</h5>
                                <p class="card-text">${topic.description}</p>
                                <p class="card-text"><small class="text-muted">话题创建者: ${topic.student_name}</small></p>
                                <p class="card-text"><small class="text-muted">创建时间: ${topic.created_at}</small></p>
                                <button type="button" class="btn btn-primary enter-discussion" data-topic-id="${topic.id}">进入讨论</button>
                            </div>
                        </div>`;
                    $("#topicsContainer").append(topicCard);
                });

                $(".enter-discussion").click(function() {
                    var topicId = $(this).data("topic-id");
                    loadDiscussion(topicId);
                });
            },
            error: function(error) {
                console.log("话题加载失败:", error);
            }
        });
    }

    function loadDiscussion(topicId) {
        $.ajax({
            url: `/api/topic_detail/${topicId}/`,
            type: "GET",
            success: function(topic) {
                var discussionContent = `
                    <div>
                <h5 class="card-title">所属模块：${topic.module === 'teacher_qa' ? '老师答疑区' : (topic.module === 'general_discussion' ? '综合讨论区' : topic.module)}</h5>

                        <h5>${topic.title}</h5>
                        <p>${topic.description}</p>
                        <p><small class="text-muted">话题创建者: ${topic.student_name}</small></p>
                        <p><small class="text-muted">创建时间: ${topic.created_at}</small></p>
                    </div>
                    <div id="commentsContainer-${topic.id}" class="mt-3"></div>`;
                $("#discussionContent").html(discussionContent);
                $("#topicIdInput").val(topic.id);
                $("#parentCommentIdInput").val('');
                loadComments(topic.id);
                $('#discussionModal').modal('show');
            },
            error: function(error) {
                console.log("讨论详情加载失败:", error);
            }
        });
    }

    function loadComments(topicId) {
        $.ajax({
            url: `/api/comments_list/${topicId}/`,
            type: "GET",
            success: function(comments) {
                var commentsContainer = $(`#commentsContainer-${topicId}`);
                commentsContainer.empty();
                comments.forEach(function(comment) {
                    var commentCard = `
                        <div class="card mb-3">
                            <div class="card-body">
                                <p class="card-text">${comment.content}</p>
                                <p class="card-text"><small class="text-muted">评论者: ${comment.student_name}</small></p>
                                <p class="card-text"><small class="text-muted">评论时间: ${comment.created_at}</small></p>
                                <button type="button" class="btn btn-primary reply-comment" data-topic-id="${topicId}" data-comment-id="${comment.id}">回复</button>
                            </div>
                        </div>`;

                    // 如果有回复，则显示回复
                    if (comment.replies.length > 0) {
                        comment.replies.forEach(function(reply) {
                            var replyCard = `
                                <div class="card ml-5 mb-3">
                                    <div class="card-body">
                                        <p class="card-text">${reply.content}</p>
                                        <p class="card-text"><small class="text-muted">评论者: ${reply.student_name}</small></p>
                                        <p class="card-text"><small class="text-muted">评论时间: ${reply.created_at}</small></p>
                                    </div>
                                </div>`;
                            commentCard += replyCard;
                        });
                    }

                    commentsContainer.append(commentCard);
                });

                // 重新绑定回复按钮的点击事件
                $(".reply-comment").click(function() {
                    var topicId = $(this).data("topic-id");
                    var commentId = $(this).data("comment-id");
                    $("#parentCommentIdInput").val(commentId);
                    // 重新加载评论列表
                    loadComments(topicId);
                });
            },
            error: function(error) {
                console.log("评论加载失败:", error);
            }
        });
    }

    $("#submitTopic").click(function() {
        var formData = $("#newTopicForm").serialize();
        $.ajax({
            url: "/api/topics/",
            type: "POST",
            data: formData,
            success: function(response) {
                $('#newTopicModal').modal('hide');
                loadTopics();
            },
            error: function(error) {
                console.log("创建话题失败:", error);
            }
        });
    });

    $("#submitComment").click(function() {
        var formData = {
            content: $("#contentInput").val(),
            topic_id: $("#topicIdInput").val(),
            parent_comment_id: $("#parentCommentIdInput").val() || null  // 确保 parent_comment_id 是 null 而不是空字符串
        };

        console.log("提交评论数据: ", formData);  // 检查提交的数据是否正确

        $.ajax({
            url: "/api/comments/",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(formData),
            success: function(response) {
                // 提交成功后重新加载评论列表
                loadComments(formData.topic_id);
                $("#contentInput").val(''); // 清空评论内容输入框
                $("#parentCommentIdInput").val(''); // 清空父评论 ID
            },
            error: function(error) {
                console.log("评论提交失败:", error);
            }
        });
    });

    // 初始加载话题列表
    loadTopics();
});


</script>

</body>
</html>
